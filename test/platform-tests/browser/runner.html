<html>
    <head>
        <script src="lib/jquery.js"></script>
        <script src="lib/async.js"></script>
        <script src="lib/qunit-1.11.0.js"></script>

        <link rel="stylesheet" href="lib/qunit-1.11.0.css">

        <script src="/dist/scxml.js"></script>

        <script src="tests.js"></script>
        <script src="runner.js"></script>
    </head>
    <body>
</head>
<body>
        <div id="qunit"></div>
        <div id="qunit-fixture"></div>
        <script>
TEST_REGISTRY.forEach(function(test){
    var tmp = test.name.split('/'), testGroup = tmp[0], testName = tmp[1];

    module(testGroup);
    asyncTest(testName,function(){
        $.getJSON(test.test,function(testScript){
            scxml.urlToModel(test.scxml,function(err,model){
                if(err) throw err;

                var sc = new scxml.scion.Statechart(model);
                var actualInitialConf = sc.start();

                console.log('initial configuration',actualInitialConf);

                deepEqual(actualInitialConf.sort(),testScript.initialConfiguration.sort(),'initial configuration');

                async.forEachSeries(testScript.events,function(nextEvent,cb){

                    function ns(){
                        console.log('sending event',nextEvent.event);

                        var actualNextConf = sc.gen(nextEvent.event);

                        console.log('next configuration',actualNextConf);

                        deepEqual(actualNextConf.sort(),nextEvent.nextConfiguration.sort(),'next configuration after sending event ' + JSON.stringify(nextEvent));

                        cb();
                    }

                    if(nextEvent.after){
                        console.log('Test harness waiting',nextEvent.after,'ms before sending next event');
                        setTimeout(ns,nextEvent.after);
                    }else{
                        ns();
                    }
                },start);

            });
        });
    });
});
        </script>
    </body>
</html>
